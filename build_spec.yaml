version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
failImmediatelyOnError: true
env:
  exportedVariables:
    - now
    - plan_job_id

steps:
  - type: Command
    name: "Install jq"
    runAs: root
    command: |
      yum install -y jq
  - type: Command
    name: "terraform plan"
    command: |
      now=`date +'%Y%m%d%H%M%S'`
      plan_job_id=$(oci resource-manager job create-plan-job \
      --stack-id ocid1.ormstack.oc1.iad.amaaaaaacsgkr3yamog27tijl4pliwsye52ab2fff63kva47sgu6idcod3ia \
      --display-name terraform_plan_${now} \
      --wait-for-state "SUCCEEDED" \
      --wait-for-state "FAILED" \
      --query "data"  | jq -r '.["id"]')
  - type: Command
    name: "terraform apply"
    failImmediatelyOnError: false
    command: |
      now=`date +'%Y%m%d%H%M%S'`
      oci resource-manager job create-apply-job \
      --stack-id ocid1.ormstack.oc1.iad.amaaaaaacsgkr3yamog27tijl4pliwsye52ab2fff63kva47sgu6idcod3ia \
      --execution-plan-strategy ${plan_job_id} \
      --display-name terraform_apply_${now}
